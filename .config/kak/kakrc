# Preferences
# ───────────

colorscheme gruvbox

hook global WinCreate ^[^*]+$ %{ add-highlighter window/ number-lines -hlcursor }

set global autoinfo command|onkey|normal
set global grepcmd 'rg -Hn'
set global indentwidth 2
set global scrolloff 3,3
set global tabstop 8
set global ui_options ncurses_assistant=clippy ncurses_wheel_down_button=0

# Highlight the word under the cursor
# ───────────────────────────────────

declare-option -hidden regex curword
set-face global CurWord default,rgb:4a4a4a

hook global NormalIdle .* %{
    eval -draft %{ try %{
        exec <space><a-i>w <a-k>\A\w+\z<ret>
        set-option buffer curword "\b\Q%val{selection}\E\b"
    } catch %{
        set-option buffer curword ''
    } }
}
add-highlighter global/ dynregex '%opt{curword}' 0:CurWord

# Find files under current directory
# ──────────────────────────────────

def find -params 1 -shell-script-candidates %{ find -type f } %{ edit %arg{1} }

# Plugins
# ───────

source "%val{config}/plugins/plug.kak/rc/plug.kak"

plug "andreyorst/smarttab.kak" defer smarttab %{
    set-option global softtabstop 2
} config %{
    # these languages will use `expandtab' behavior
    hook global WinSetOption filetype=(rust|markdown|kak|lisp|scheme|sh|perl) expandtab
    # these languages will use `noexpandtab' behavior
    hook global WinSetOption filetype=(makefile|gas) noexpandtab
    # these languages will use `smarttab' behavior
    hook global WinSetOption filetype=(c|cpp) smarttab
}
plug "lePerdu/kakboard" config %{
    hook global WinCreate .* %{ kakboard-enable }
}
plug "ul/kak-lsp" do %{
    cargo install --locked --force --path .
} config %{
    map -docstring "Language server commands" global user <l> %{:enter-user-mode lsp<ret>}

    hook global WinSetOption filetype=(rust|python|go|javascript|typescript|c|cpp) %{
        lsp-enable-window
        lsp-auto-hover-enable
    }

    # Inlay hints for rust-analyzer
    hook global WinSetOption filetype=rust %{
        hook window -group rust-inlay-hints BufReload .* rust-analyzer-inlay-hints
        hook window -group rust-inlay-hints NormalIdle .* rust-analyzer-inlay-hints
        hook window -group rust-inlay-hints InsertIdle .* rust-analyzer-inlay-hints
        hook -once -always window WinSetOption filetype=.* %{
            remove-hooks window rust-inlay-hints
        }
    }

    # Semantic tokens
    hook global WinSetOption filetype=<language> %{
        hook window -group semantic-tokens BufReload .* lsp-semantic-tokens
        hook window -group semantic-tokens NormalIdle .* lsp-semantic-tokens
        hook window -group semantic-tokens InsertIdle .* lsp-semantic-tokens
        hook -once -always window WinSetOption filetype=.* %{
            remove-hooks window semantic-tokens
        }
    }

    eval %sh{kak-lsp --kakoune -s $kak_session}
}
plug "https://gitlab.com/Screwtapello/kakoune-cargo" config %{
    map -docstring "Cargo commands" global user <c> %{:enter-user-mode cargo<ret>}
}

# Mappings
# ────────

map global normal <%> '<c-s>%' # Save position before %
map global normal '#' :comment-line<ret>

# Enable <tab>/<s-tab> for insert completion selection
# ────────────────────────────────────────────────────

hook global InsertCompletionShow .* %{ map window insert <tab> <c-n>; map window insert <s-tab> <c-p> }
hook global InsertCompletionHide .* %{ unmap window insert <tab> <c-n>; unmap window insert <s-tab> <c-p> }
